# κ°μΈμ •λ³΄ μ „μ²΄ μ•”νΈν™” μ‘μ—… μ§„ν–‰ μƒν™©

**μ‘μ—… μΌμ‹**: 2025-11-08
**λ©μ **: λ¨λ“  κ°μΈμ •λ³΄ ν•„λ“λ¥Ό AES-256-GCMμΌλ΅ μ•”νΈν™”

---

## π“‹ μ•”νΈν™” λ€μƒ ν•„λ“

| ν•„λ“               | νƒ€μ…   | κΈ°μ΅΄ μƒνƒ   | μ‘μ—… μƒνƒ |
|------------------|------|---------|---------|
| performerContact | μ „ν™”λ²νΈ | β… μ•”νΈν™”λ¨ | μ™„λ£ |
| metadata         | JSON | β… μ•”νΈν™”λ¨ | μ™„λ£ |
| clientContact    | μ „ν™”λ²νΈ | β… μ•”νΈν™”λ¨ | μ™„λ£ |
| performerEmail   | μ΄λ©”μΌ  | β… μ•”νΈν™”λ¨ | μ™„λ£ |
| performerName    | μ΄λ¦„    | β… μ•”νΈν™”λ¨ | μ™„λ£ |
| clientEmail      | μ΄λ©”μΌ  | β… μ•”νΈν™”λ¨ | μ™„λ£ |
| contractMailLog.recipientEmail | μ΄λ©”μΌ | β… μ•”νΈν™”λ¨ | μ™„λ£ |

---

## β… μ™„λ£λ μ‘μ—…

### 1. DB μ¤ν‚¤λ§ λ³€κ²½ μ™„λ£ β…

**νμΌ**: `nestjs_app/src/contracts/contract.entity.ts`

```typescript
// λ³€κ²½ λ‚΄μ©:
@Column({ name: "client_contact", type: "varchar", length: 255 })  // 60 β†’ 255
clientContact!: string | null;

@Column({ name: "client_email", type: "varchar", length: 255 })    // 190 β†’ 255
clientEmail!: string | null;

@Column({ name: "performer_email", type: "varchar", length: 255 }) // 190 β†’ 255
performerEmail!: string | null;
```

### 2. DB ALTER μ¤ν¬λ¦½νΈ μ‹¤ν–‰ μ™„λ£ β…

**μ‹¤ν–‰ λ…λ Ή**:
```bash
npm run migrate:alter-schema-all
```

**λ³€κ²½λ μ»¬λΌ**:
- β… `client_contact`: VARCHAR(60) β†’ VARCHAR(255)
- β… `client_email`: VARCHAR(190) β†’ VARCHAR(255)
- β… `performer_email`: VARCHAR(190) β†’ VARCHAR(255)

**κ²°κ³Ό**: λ¨λ“  μ»¬λΌμ΄ μ•”νΈν™”λ λ°μ΄ν„°λ¥Ό μ €μ¥ν•  μ μλ„λ΅ ν™•μ¥λ¨

### 3. ContractsService λ°νƒ€μ„ μ•”νΈν™”/λ³µνΈν™” μ μ© β…

- `createContract`μ—μ„ `clientName`, `clientContact`, `clientEmail`, `performerEmail`, `performerName`μ„ `EncryptionService`λ΅ μ•”νΈν™” μ €μ¥.
- `decryptContractFields`κ°€ λ™μΌ ν•„λ“λ¥Ό λ³µνΈν™”ν•μ—¬ API/ν…ν”λ¦Ώμ— ν‰λ¬Έ λ…Έμ¶.
- `declineSignature`, `completeSignature`λ” μ΄μ  μ•”νΈν™”λ μ›λ³Έμ„ λ΅λ“ ν›„ μ €μ¥ν•λ©°, λ°ν™ μ‹μ—λ§ λ³µνΈν™” β†’ DBμ— ν‰λ¬Έμ΄ λ‹¤μ‹ μ €μ¥λλ” λ¬Έμ  λ°©μ§€.
- λ©”νƒ€λ°μ΄ν„° μ¤λƒ…μƒ· ν—¬νΌ(`extractMetadataSnapshot`)λ΅ λ³µνΈν™” μ—†μ΄λ„ DTO λ³‘ν•© ν›„ μ¬μ•”νΈν™”.

### 4. μ΄λ©”μΌ λ°μ†΅ κ²½λ΅ μ•μ „ν™” β…

- `dispatchSignatureRequest`κ°€ μν–‰μ μ΄λ©”μΌμ„ μ„μ‹ λ³µνΈν™”ν•μ—¬ λ©”μΌ μ „μ†΅/λ΅κ·Έ κΈ°λ΅, DBμ—λ” μ•”νΈλ¬Έ μ μ§€.
- λ³µνΈν™” μ‹¤ν¨ μ‹ `strict` λ¨λ“μ—μ„λ” μ¦‰μ‹ μ¤λ¥, κ·Έ μ™Έμ—λ” μ „μ†΅ μ¤ν‚µ.

### 5. μν–‰μ μ΄λ¦„ μ•”νΈν™” μ μ© β…

- `performerName`λ„ AES μ•”νΈν™” λ€μƒμ— ν¬ν•¨. μƒμ„± μ‹ μ•”νΈν™”λκ³ , μ΅°ν/κ²€μ¦ μ‹ λ³µνΈν™”λμ–΄ FlutterΒ·AdminΒ·PDF κ²½λ΅μ—μ„ ν‰λ¬ΈμΌλ΅ λ™μ‘.
- μ‹ μ›ν™•μΈ(`verifyPerformerIdentity`) λ΅μ§μ€ λ³µνΈν™”λ¥Ό κ±°μΉ κ°’μ„ μ‚¬μ©ν•λ―€λ΅ μ¶”κ°€ λ³€κ²½ μ—†μ.

### 6. μ•”νΈν™” μ κ²€ μ¤ν¬λ¦½νΈ κ³ λ„ν™” β…

- `npm run check:encryption`μ΄ μ΄μ  `clientContact`, `clientEmail`, `performerEmail`, `performerContact`, `metadata` μ „λ¶€μ μµκ·Ό 5κ±΄ μƒνƒμ™€ μ „μ²΄ ν†µκ³„λ¥Ό μ¶λ ¥.
- μ•”νΈν™” μ—¬λ¶€ κ²€μ‚¬λ” `hex:hex:hex` ν¨ν„΄ μ •κ·μ‹μΌλ΅ ν†µμΌ.

### 7. κΈ°μ΅΄ λ°μ΄ν„° λ§μ΄κ·Έλ μ΄μ… μ¤ν¬λ¦½νΈ ν™•μ¥ β…

- `src/scripts/encrypt-all-personal-data.ts` μ‘μ„± μ™„λ£.
- μµμ‹  μ‹¤ν–‰ λ΅κ·Έ (2025-11-08 11:35):
  - clientName: μƒλ΅ μ•”νΈν™” 8κ±΄.
  - clientContact/clientEmail/performerEmail/performerName: μ΄λ―Έ μ•”νΈν™” 8κ±΄.
  - performerContact 8κ±΄, metadata 7κ±΄μ€ κΈ°μ΅΄ μ•”νΈν™”, λΉκ°’ 1κ±΄.
- κ³„μ•½λ³„ ν•„λ“ μƒνƒ/ν†µκ³„λ¥Ό λ΅κ·Έλ΅ λ‚¨κΈ°κ³ , μ”μ—¬ ν‰λ¬Έμ΄ μλ” κ²½μ° κ²½κ³  μ¶λ ¥.

### 8. users.email μ•”νΈν™” β…

- `users` ν…μ΄λΈ”μ— `email_hash (SHA-256)` μ»¬λΌ μ¶”κ°€ λ° μ λ‹ν¬ μΈλ±μ¤ λ¶€μ—¬.
- `UsersService`κ°€ μ΄λ©”μΌμ„ AESλ΅ μ•”νΈν™”ν•΄ μ €μ¥ν•κ³ , κ²€μƒ‰μ€ ν•΄μ‹ μ»¬λΌμΌλ΅ μν–‰.
- `InboxService` κ²€μƒ‰μ€ μ΄λ©”μΌ ν¨ν„΄μ΄ λ“¤μ–΄μ¨ κ²½μ° ν•΄μ‹ κΈ°μ¤€μΌλ΅ ν•„ν„°λ§.
- μ¤ν¬λ¦½νΈ μ‹¤ν–‰:
  ```bash
  npm run migrate:alter-users-email
  npm run migrate:encrypt-user-emails
  ```
- μ‹¤ν–‰ κ²°κ³Ό: 2λ…μ μ‚¬μ©μ μ΄λ©”μΌ μ•”νΈν™”/ν•΄μ‹ κ°±μ‹  μ™„λ£, μ”μ—¬ ν‰λ¬Έ 0λ….

### 9. κ³„μ•½ λ©”μΌ λ΅κ·Έ μ•”νΈν™” β…

- `contract_mail_logs.recipient_email` μ»¬λΌ κΈΈμ΄ ν™•μ¥ λ° AES μ•”νΈν™” μ μ©.
- λ°νƒ€μ„μ—μ„ λ©”μΌ λ΅κ·Έλ¥Ό μƒμ„±ν•  λ• μ•”νΈν™”λ μ£Όμ†λ§ μ €μ¥λλ„λ΅ `ContractsService` μμ •.
- κΈ°μ΅΄ λ°μ΄ν„° μ•”νΈν™”: `npm run migrate:alter-contract-mail-logs && npm run migrate:encrypt-contract-mail-logs`
- μ‹¤ν–‰ κ²°κ³Ό: 8κ±΄ μƒλ΅ μ•”νΈν™”, μ”μ—¬ ν‰λ¬Έ 0κ±΄.

---

## π”„ λ‹¤μ μ‘μ—… (λ‚¨μ€ μ‘μ—…)

### A. κΈ°μ΅΄ λ°μ΄ν„° μ•”νΈν™” μ‹¤ν–‰

1. λ°±μ—… ν™•μΈ (`contracts_backup_YYYYMMDD.sql` λ“± μµμ‹ λ³Έ μ΅΄μ¬ μ—¬λ¶€).
2. μ‹¤ν–‰: `npm run migrate:encrypt-all-personal-data` (λ΅μ»¬ DB URL/ENV ν™•μΈ ν•„μ”).
3. λ΅κ·Έμ— μ”μ•½ ν†µκ³„κ°€ μ¶λ ¥λλ©°, λ―Έμ•”νΈν™” κ±΄μ΄ λ‚¨μΌλ©΄ μ¤ν¬λ¦½νΈκ°€ κ²½κ³ .

### B. μ•”νΈν™” μƒνƒ μ κ²€

1. μ‹¤ν–‰: `npm run check:encryption`.
2. μµκ·Ό 5κ±΄ λ―Έλ¦¬λ³΄κΈ°μ™€ μ „μ²΄ ν†µκ³„λ¥Ό μΊ΅μ²ν•΄ PRμ— μ²¨λ¶€.

### C. ν›„μ† κ²€ν†  ν•­λ©

1. μ΄λ©”μΌ κ²€μƒ‰ ν•„μ”ν• κ²½μ° `*_EmailHash (SHA256)` λ³΄μ΅°μ»¬λΌ μ¶”κ°€ μ—¬λ¶€ λ…Όμ.
2. Contract Mail Log λ“± 2μ°¨ μ €μ¥μ†μ—λ„ μ•”νΈν™”κ°€ ν•„μ”ν•μ§€ λ³΄μ•ν€κ³Ό ν‘μ.
3. E2E μ‹λ‚λ¦¬μ¤: μƒμ„± β†’ μ„λ…μ”μ²­ β†’ μ„λ…μ™„λ£ β†’ κ±°μ  ν”λ΅μ° μ „μ²΄ ν…μ¤νΈ (μ•”νΈν™” ν•„λ“κ°€ μ •μƒ λ³µνΈν™”λλ”μ§€ ν™•μΈ).

---

## π€ μ¬μ‹μ‘ μ‹ μ‹¤ν–‰ μμ„

1. **ν™κ²½ μ¤€λΉ„**
   ```bash
   cd nestjs_app
   npm install
   ```

2. **κΈ°μ΅΄ λ°μ΄ν„° μ•”νΈν™”**
   ```bash
   npm run migrate:encrypt-all-personal-data
   ```

3. **μƒνƒ κ²€μ¦**
   ```bash
   npm run check:encryption
   ```

4. **E2E μ‹λ‚λ¦¬μ¤ μλ™ μ κ²€**
   - κ³„μ•½ μƒμ„± β†’ μ„λ… μ”μ²­ λ°μ†΅ β†’ μ„λ… μ™„λ£/κ±°μ  νλ¦„
   - Admin/ν¬ν„Έμ—μ„ κ°μΈμ •λ³΄κ°€ μ •μƒ λ³µνΈν™”λλ”μ§€ ν™•μΈ

5. **PR μ¦λΉ™**
   - λ§μ΄κ·Έλ μ΄μ…/κ²€μ¦ λ΅κ·Έ μ²¨λ¶€
   - μ‹ κ· μ¤ν¬λ¦½νΈ μ‹¤ν–‰ κ°€μ΄λ“μ™€ λ°±μ—… μ—¬λ¶€ κΈ°λ΅

---

## β οΈ μ£Όμμ‚¬ν•­

1. **λ°±μ—… ν•„μ**
   - λ§μ΄κ·Έλ μ΄μ… μ „ λ°λ“μ‹ DB λ°±μ—…
   - `mysqldump -u insign -p insign > backup_before_encryption.sql`

2. **μ•”νΈν™” ν‚¤ κ΄€λ¦¬**
   - ENCRYPTION_KEYλ” μ λ€ λ³€κ²½ κΈμ§€
   - ν‚¤λ¥Ό μƒμΌλ©΄ μ•”νΈν™”λ λ°μ΄ν„° λ³µκµ¬ λ¶κ°€λ¥

3. **κ²€μƒ‰ κΈ°λ¥**
   - μ•”νΈν™” ν›„ LIKE κ²€μƒ‰ λ¶κ°€
   - ν•„μ”μ‹ ν•΄μ‹ μΈλ±μ¤ λ³„λ„ κµ¬ν„

4. **μ„±λ¥**
   - λ€λ‰ μ΅°ν μ‹ λ³µνΈν™” μ¤λ²„ν—¤λ“ κ³ λ ¤
   - ν•„μ”μ‹ μΊμ‹± μ „λµ μλ¦½

---

## π“ μ°Έκ³  νμΌ

- `nestjs_app/src/common/encryption.service.ts` - μ•”νΈν™” μ„λΉ„μ¤
- `nestjs_app/src/contracts/contract.entity.ts` - μ—”ν‹°ν‹° μ •μ
- `nestjs_app/src/contracts/contracts.service.ts` - λΉ„μ¦λ‹μ¤ λ΅μ§
- `nestjs_app/src/scripts/encrypt-existing-contracts.ts` - κΈ°μ΅΄ μ•”νΈν™” μ¤ν¬λ¦½νΈ μ°Έκ³ 

---

## π’΅ μ™„λ£ ν›„ ν™•μΈμ‚¬ν•­

- [ ] λ¨λ“  κ°μΈμ •λ³΄ ν•„λ“κ°€ μ•”νΈν™”λ¨
- [ ] κΈ°μ΅΄ λ°μ΄ν„° λ§μ΄κ·Έλ μ΄μ… μ™„λ£
- [ ] API μ‘λ‹µμ—μ„ κ°μΈμ •λ³΄κ°€ λ³µνΈν™”λμ–΄ ν‘μ‹λ¨
- [ ] μ„λ… ν”„λ΅μ„Έμ¤κ°€ μ •μƒ μ‘λ™ν•¨
- [ ] κ²€μƒ‰ κΈ°λ¥μ΄ ν•„μ”ν• κ²½μ° ν•΄μ‹ μΈλ±μ¤ μ¶”κ°€ κ³„ν μλ¦½

---

**μ‘μ—… μ¬κ° μ‹ μ΄ νμΌμ„ μ°Έκ³ ν•μ—¬ "A. κΈ°μ΅΄ λ°μ΄ν„° μ•”νΈν™” μ‹¤ν–‰"λ¶€ν„° μ§„ν–‰ν•μ„Έμ”!**
