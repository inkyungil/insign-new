# ì‘ì—… ë‚´ì—­ - 2025ë…„ 11ì›” 27ì¼

## ğŸ“‹ ì‘ì—… ìš”ì•½

1. âœ… ì„±ê´€ê³„ ë™ì˜ì„œ í…œí”Œë¦¿ ì„œëª… ì´ë¯¸ì§€ í‘œì‹œ ë¬¸ì œ í•´ê²°
2. âœ… í…œí”Œë¦¿ í•„ë“œëª… í‘œì¤€í™” (ì¼ê´€ì„± í™•ë³´)
3. âœ… ê³„ì•½ì„œ ì‘ì„± ì‹œ ì‚¬ìš©ì ì •ë³´ ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥ ì¶”ê°€
4. âœ… ì•± ê°œì„ ì•ˆ ì¢…í•© ë¶„ì„ (ë³„ë„ íŒŒì¼)
5. âœ… ì„œëª… ì™„ë£Œ ì‹œ ê°‘(ì‘ì„±ì)ì—ê²Œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ê¸°ëŠ¥ ì¶”ê°€

---

## 1ï¸âƒ£ ì„±ê´€ê³„ ë™ì˜ì„œ í…œí”Œë¦¿ ì„œëª… ì´ë¯¸ì§€ í‘œì‹œ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ ìƒí™©
- ì„±ê´€ê³„ ë™ì˜ì„œ í…œí”Œë¦¿ì—ì„œ ê°‘ê³¼ ì„ì˜ ì„œëª… ì´ë¯¸ì§€ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ
- ë‹¤ë¥¸ í…œí”Œë¦¿(ê·¼ë¡œê³„ì•½ì„œ, ì°¨ìš©ì¦)ì—ì„œëŠ” ì •ìƒ ì‘ë™

### ì›ì¸ ë¶„ì„
```bash
# ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
mysql> SELECT content FROM templates WHERE id = 6;
# ê²°ê³¼: {{partyASignature}}, {{partyBSignature}} ì‚¬ìš©

# ë‹¤ë¥¸ í…œí”Œë¦¿ í™•ì¸
í…œí”Œë¦¿ 1 (ê·¼ë¡œê³„ì•½ì„œ): {{employerSignature}}, {{employeeSignature}}
í…œí”Œë¦¿ 3 (ì°¨ìš©ì¦): {{lenderSignature}}, {{borrowerSignature}}
```

**ì›ì¸:** Flutter ì½”ë“œ(`contract_detail_screen.dart`)ì—ì„œ `partyASignature`, `partyBSignature` í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ

### í•´ê²° ë°©ë²•

**ì„ íƒ 1: Flutter ì½”ë“œ ìˆ˜ì • (ì²˜ìŒ ì œì•ˆ)**
- `contract_detail_screen.dart`ì— `partyASignature`, `partyBSignature` ë§¤í•‘ ì¶”ê°€
- ë¬¸ì œ: í–¥í›„ ë‹¤ë¥¸ í…œí”Œë¦¿ë§ˆë‹¤ ê³„ì† ì¶”ê°€í•´ì•¼ í•¨

**ì„ íƒ 2: í…œí”Œë¦¿ í•„ë“œëª… í‘œì¤€í™” (ìµœì¢… ì„ íƒ) âœ…**
- ì„œëª… í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ í‘œì¤€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
- ì¼ê´€ì„± í™•ë³´ ë° ìœ ì§€ë³´ìˆ˜ ìš©ì´

### êµ¬í˜„ ë‚´ì—­

#### 1) ì„œëª… í”Œë ˆì´ìŠ¤í™€ë” ë³€ê²½
**íŒŒì¼:** `nestjs_app/src/scripts/update-consent-template-simple.ts`

```typescript
// BEFORE
{
  id: "partyASignature",
  label: "ê°‘(ì œ1ë‹¹ì‚¬ì) ì„œëª…",
  type: "signature",
  role: "author",
  required: true,
}

// AFTER
{
  id: "authorSignature",
  label: "ê°‘(ì œ1ë‹¹ì‚¬ì) ì„œëª…",
  type: "signature",
  role: "author",
  required: true,
}
```

**ë³€ê²½ ë‚´ìš©:**
- `partyASignature` â†’ `authorSignature`
- `partyBSignature` â†’ `performerSignature`
- `partyASignDate` â†’ `authorSignDate`
- `partyBSignDate` â†’ `performerSignDate`

#### 2) HTML í…œí”Œë¦¿ í”Œë ˆì´ìŠ¤í™€ë” ë³€ê²½

```html
<!-- BEFORE -->
ì„œëª…: {{partyASignature}} / ì„œëª…ì¼: {{partyASignDate}}
ì„œëª…: {{partyBSignature}} / ì„œëª…ì¼: {{partyBSignDate}}

<!-- AFTER -->
ì„œëª…: {{authorSignature}} / ì„œëª…ì¼: {{authorSignDate}}
ì„œëª…: {{performerSignature}} / ì„œëª…ì¼: {{performerSignDate}}
```

#### 3) ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸

```bash
cd /home/insign/nestjs_app
npx ts-node -r tsconfig-paths/register src/scripts/update-consent-template-simple.ts
```

**ê²°ê³¼:**
```
âœ… ê¸°ì¡´ í…œí”Œë¦¿ì„ ë‹¨ìˆœí™”ëœ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤...
   ID: 6, Name: ì„±ì¸ ê°„ ì„±ê´€ê³„ ë™ì˜ì„œ
âœ… í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ ì™„ë£Œ!
```

#### 4) ê²€ì¦

```bash
# ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
mysql> SELECT content FROM templates WHERE id = 6 \G | grep Signature
# ê²°ê³¼:
{{authorSignature}}
{{performerSignature}}
```

### ê²°ê³¼
âœ… ì„±ê´€ê³„ ë™ì˜ì„œì—ì„œ ì„œëª… ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë¨
âœ… ë‹¤ë¥¸ í…œí”Œë¦¿ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì‘ë™

---

## 2ï¸âƒ£ í…œí”Œë¦¿ í•„ë“œëª… í‘œì¤€í™”

### ë¬¸ì œ ìƒí™©
- ì„±ê´€ê³„ ë™ì˜ì„œ í…œí”Œë¦¿ì—ì„œ ê°‘ì˜ ì—°ë½ì²˜ ìë™ ì…ë ¥ì´ ì•ˆ ë¨
- ë‹¤ë¥¸ í•„ë“œ(ì´ë¦„, ì´ë©”ì¼)ë„ ìë™ ì…ë ¥ ì•ˆ ë¨

### ì›ì¸ ë¶„ì„

**Flutter ìë™ ì…ë ¥ ë¡œì§:**
```dart
// create_contract_screen.dart
final bindings = <String, TextEditingController>{
  'clientName': _clientNameController,
  'clientContact': _clientContactController,
  'clientEmail': _clientEmailController,
};
```

**ì„±ê´€ê³„ ë™ì˜ì„œ í…œí”Œë¦¿ í•„ë“œëª…:**
- `partyAName`, `partyAEmail`, `partyAContact` (ê°‘)
- `partyBName`, `partyBEmail`, `partyBContact` (ì„)

â†’ **ë§¤ì¹­ ì•ˆ ë¨!**

### í•´ê²° ë°©ë²•

#### 1) í…œí”Œë¦¿ í•„ë“œëª…ì„ í‘œì¤€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½
**íŒŒì¼:** `nestjs_app/src/scripts/update-consent-template-simple.ts`

```typescript
// ê°‘(ì œ1ë‹¹ì‚¬ì) ì •ë³´
{
  id: "party-a-info",
  title: "ê°‘(ì œ1ë‹¹ì‚¬ì) ì •ë³´",
  role: "author",
  fields: [
    {
      id: "clientName",        // partyAName â†’ clientName
      label: "ì„±ëª…",
      type: "text",
      role: "author",
      required: true,
    },
    {
      id: "clientEmail",       // partyAEmail â†’ clientEmail
      label: "ì´ë©”ì¼",
      type: "email",
      role: "author",
      required: true,
    },
    {
      id: "clientContact",     // partyAContact â†’ clientContact
      label: "ì—°ë½ì²˜",
      type: "phone",
      role: "author",
      required: true,
    },
  ],
},

// ì„(ì œ2ë‹¹ì‚¬ì) ì •ë³´
{
  id: "party-b-info",
  title: "ì„(ì œ2ë‹¹ì‚¬ì) ì •ë³´",
  role: "recipient",
  fields: [
    {
      id: "performerName",     // partyBName â†’ performerName
      label: "ì„±ëª…",
      type: "text",
      role: "recipient",
      required: true,
    },
    {
      id: "performerEmail",    // partyBEmail â†’ performerEmail
      label: "ì´ë©”ì¼",
      type: "email",
      role: "recipient",
      required: true,
    },
    {
      id: "performerContact",  // partyBContact â†’ performerContact
      label: "ì—°ë½ì²˜",
      type: "phone",
      role: "recipient",
      required: true,
    },
  ],
},
```

#### 2) HTML í…œí”Œë¦¿ í”Œë ˆì´ìŠ¤í™€ë” ë³€ê²½

```html
<!-- ê³„ì•½ ë‹¹ì‚¬ì ì •ë³´ -->
<p class="clause">
  <span class="field-blank">{{clientName}}</span> (ì´í•˜ "ê°‘"ì´ë¼ í•¨)ê³¼(ì™€)
  <span class="field-blank">{{performerName}}</span> (ì´í•˜ "ì„"ì´ë¼ í•¨)ì€
  ìƒí˜¸ ì¡´ì¤‘ê³¼ ëª…í™•í•œ ì˜ì‚¬ì†Œí†µì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë™ì˜í•œë‹¤.
</p>

<!-- ì •ë³´ í…Œì´ë¸” -->
<tr>
  <th>ê°‘(ì œ1ë‹¹ì‚¬ì)</th>
  <td>
    ì„±ëª…: {{clientName}}<br />
    ì´ë©”ì¼: {{clientEmail}} (ì¸ì¦ ì™„ë£Œ)<br />
    ì—°ë½ì²˜: {{clientContact}}
  </td>
</tr>
<tr>
  <th>ì„(ì œ2ë‹¹ì‚¬ì)</th>
  <td>
    ì„±ëª…: {{performerName}}<br />
    ì´ë©”ì¼: {{performerEmail}} (ì¸ì¦ ì™„ë£Œ)<br />
    ì—°ë½ì²˜: {{performerContact}}
  </td>
</tr>

<!-- ì„œëª… í…Œì´ë¸” -->
<tr>
  <th>ê°‘(ì œ1ë‹¹ì‚¬ì)</th>
  <td>
    ì„±ëª…: {{clientName}}<br />
    ì´ë©”ì¼: {{clientEmail}}<br />
    ì—°ë½ì²˜: {{clientContact}}<br />
    ì„œëª…: {{authorSignature}} / ì„œëª…ì¼: {{authorSignDate}}
  </td>
</tr>
<tr>
  <th>ì„(ì œ2ë‹¹ì‚¬ì)</th>
  <td>
    ì„±ëª…: {{performerName}}<br />
    ì´ë©”ì¼: {{performerEmail}}<br />
    ì—°ë½ì²˜: {{performerContact}}<br />
    ì„œëª…: {{performerSignature}} / ì„œëª…ì¼: {{performerSignDate}}
  </td>
</tr>
```

#### 3) samplePayload ì—…ë°ì´íŠ¸

```typescript
const samplePayload = {
  contractDate: "2025-11-27",
  clientName: "í™ê¸¸ë™",           // partyAName â†’ clientName
  clientEmail: "hong@example.com", // partyAEmail â†’ clientEmail
  clientContact: "010-1234-5678",  // partyAContact â†’ clientContact
  performerName: "ê¹€ì˜í¬",         // partyBName â†’ performerName
  performerEmail: "kim@example.com", // partyBEmail â†’ performerEmail
  performerContact: "010-9876-5432", // partyBContact â†’ performerContact
  recordingProhibition: true,
  dataUsageProhibition: true,
  voluntaryConsent: true,
  withdrawalRight: true,
  authorSignature: "í™ê¸¸ë™",
  authorSignDate: "2025-11-27",
  performerSignature: "ê¹€ì˜í¬",
  performerSignDate: "2025-11-27",
};
```

#### 4) ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸

```bash
cd /home/insign/nestjs_app
npx ts-node -r tsconfig-paths/register src/scripts/update-consent-template-simple.ts
```

### ê²°ê³¼
âœ… ì„±ê´€ê³„ ë™ì˜ì„œ ì‘ì„± ì‹œ ê°‘ì˜ ì´ë¦„, ì´ë©”ì¼, ì—°ë½ì²˜ê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì§
âœ… ëª¨ë“  í…œí”Œë¦¿ì´ ë™ì¼í•œ í•„ë“œëª… ì‚¬ìš© (ì¼ê´€ì„± í™•ë³´)
âœ… Flutter ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”

---

## 3ï¸âƒ£ ê³„ì•½ì„œ ì‘ì„± ì‹œ ì‚¬ìš©ì ì •ë³´ ìë™ ì±„ìš°ê¸°

### ë¬¸ì œ ìƒí™©
- ë¡œê·¸ì¸í•œ ìƒíƒœì—ì„œ ê³„ì•½ì„œë¥¼ ì‘ì„±í•  ë•Œ
- ê°‘(ì‘ì„±ì)ì˜ ì´ë¦„, ì´ë©”ì¼ì„ ë§¤ë²ˆ ì…ë ¥í•´ì•¼ í•¨
- ë¶ˆí¸í•˜ê³  ë²ˆê±°ë¡œì›€

### í•´ê²° ë°©ë²•

#### 1) AuthCubitì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°

**User ëª¨ë¸ í™•ì¸:**
```dart
class User {
  final int id;
  final String email;
  final String? displayName;  // ì‚¬ìš© ê°€ëŠ¥
  final String? lastLoginAt;
  final String? provider;
  final String? avatarUrl;
}
```

**AuthCubit:**
```dart
class AuthCubit extends Cubit<AuthState> {
  User? get currentUser => state.user;  // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
}
```

#### 2) create_contract_screen.dart ìˆ˜ì •

**íŒŒì¼:** `insign_flutter/lib/features/contracts/view/create_contract_screen.dart`

**Import ì¶”ê°€:**
```dart
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:insign/features/auth/cubit/auth_cubit.dart';
```

**initStateì— ìë™ ì±„ìš°ê¸° ë¡œì§ ì¶”ê°€:**
```dart
@override
void initState() {
  super.initState();
  _includeAmount = _amountController.text.isNotEmpty;
  _loadUserInfo();  // ì¶”ê°€!
  _registerAuthorFieldBindings();
  if (widget.templateId != null) {
    _loadTemplate(widget.templateId!);
  } else {
    _loadDefaultTemplate();
  }
  // ì„ì‹œ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° (í…œí”Œë¦¿ ë¡œë”© í›„)
  Future.delayed(const Duration(milliseconds: 500), () {
    _loadDraft();
  });
}
```

**_loadUserInfo ë©”ì„œë“œ ì¶”ê°€:**
```dart
void _loadUserInfo() {
  final authCubit = context.read<AuthCubit>();
  final user = authCubit.currentUser;

  if (user != null) {
    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ë¡œ ê°‘(ì‘ì„±ì) ì •ë³´ ìë™ ì±„ìš°ê¸°
    if (user.displayName != null && user.displayName!.isNotEmpty) {
      _clientNameController.text = user.displayName!;
    }
    if (user.email.isNotEmpty) {
      _clientEmailController.text = user.email;
    }
    // ì—°ë½ì²˜ëŠ” User ëª¨ë¸ì— ì—†ìœ¼ë¯€ë¡œ ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•´ì•¼ í•¨
  }
}
```

### ë™ì‘ ë°©ì‹

```
1. ì‚¬ìš©ì ë¡œê·¸ì¸ ì™„ë£Œ
   â†“
2. ê³„ì•½ì„œ ì‘ì„± í™”ë©´ ì§„ì…
   â†“
3. initStateì—ì„œ _loadUserInfo() í˜¸ì¶œ
   â†“
4. AuthCubitì—ì„œ currentUser ê°€ì ¸ì˜¤ê¸°
   â†“
5. displayName â†’ _clientNameController
   email â†’ _clientEmailController
   â†“
6. ê°‘(ì‘ì„±ì) ì •ë³´ ìë™ ì…ë ¥ ì™„ë£Œ!
   (ì—°ë½ì²˜ë§Œ ìˆ˜ë™ ì…ë ¥)
```

### ê²°ê³¼
âœ… ê³„ì•½ì„œ ì‘ì„± ì‹œ ì´ë¦„ê³¼ ì´ë©”ì¼ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì§
âœ… ìˆ˜ì •ë„ ê°€ëŠ¥ (TextFieldì´ë¯€ë¡œ)
âœ… ì‚¬ìš©ì í¸ì˜ì„± ëŒ€í­ í–¥ìƒ

### í–¥í›„ ê°œì„  ì‚¬í•­
âš ï¸ User ëª¨ë¸ì— `phone` í•„ë“œ ì¶”ê°€í•˜ë©´ ì—°ë½ì²˜ë„ ìë™ ì…ë ¥ ê°€ëŠ¥
```dart
class User {
  final String? phone;  // ì¶”ê°€ í•„ìš”
  final String? address;  // ì£¼ì†Œë„ ì¶”ê°€í•˜ë©´ ì¢‹ìŒ
}
```

---

## 4ï¸âƒ£ ì•± ê°œì„ ì•ˆ ì¢…í•© ë¶„ì„

### íŒŒì¼ ìœ„ì¹˜
`/home/insign/ì•±_ê°œì„ ì•ˆ_ë¶„ì„_2025-11-27.md`

### ì£¼ìš” ë‚´ìš©
1. **í˜„ì¬ ìƒíƒœ ìš”ì•½** (ê°•ì /ì•½ì  ë¶„ì„)
2. **ìš°ì„ ìˆœìœ„ë³„ ê°œì„ ì•ˆ**
   - ğŸ”´ ìš°ì„ ìˆœìœ„ 1: ì¦‰ì‹œ í•„ìš” (1-2ì£¼)
   - ğŸŸ¡ ìš°ì„ ìˆœìœ„ 2: ì¤‘ìš” (1-2ê°œì›”)
   - ğŸŸ¢ ìš°ì„ ìˆœìœ„ 3: ìˆìœ¼ë©´ ì¢‹ìŒ (3-6ê°œì›”)
3. **ì½”ë“œ í’ˆì§ˆ ê°œì„ ** (ê°œë°œììš©)
4. **UX ê°œì„  ì•„ì´ë””ì–´**
5. **ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ì  ê°œì„ ì•ˆ** (ìˆ˜ìµí™”)
6. **ë¹ ë¥¸ ê°œì„  ì²´í¬ë¦¬ìŠ¤íŠ¸** (1-2ì¼ ì†Œìš”)
7. **ì¶”ì²œ ë¡œë“œë§µ** (Phase 1~4)

### ê°€ì¥ í° ì˜í–¥ë ¥ TOP 3
1. ğŸ¥‡ **ì‚¬ìš©ì í”„ë¡œí•„ì— ì—°ë½ì²˜ ì¶”ê°€** - ë§¤ë²ˆ ì…ë ¥í•˜ëŠ” ë¶ˆí¸í•¨ í•´ì†Œ
2. ğŸ¥ˆ **ê²€ìƒ‰ ê¸°ëŠ¥ ê°œì„ ** - ê³„ì•½ì„œ ë§ì•„ì§€ë©´ í•„ìˆ˜
3. ğŸ¥‰ **ì¼ê´„ ì‘ì—… ê¸°ëŠ¥** - ìƒì‚°ì„± 10ë°° í–¥ìƒ

---

## 5ï¸âƒ£ ì„œëª… ì™„ë£Œ ì‹œ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€

### ìš”êµ¬ì‚¬í•­
- ì„(ìˆ˜í–‰ì)ì´ ê³„ì•½ì„œ ì„œëª…ì„ ì™„ë£Œí•˜ë©´
- ê°‘(ì‘ì„±ì)ì—ê²Œ FCM í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
- ë¬¼ë¡  í‘¸ì‹œ ì•Œë¦¼ ë™ì˜ê°€ ë˜ì–´ì•¼ í•¨

### êµ¬í˜„ ë‚´ì—­

#### 1) PushNotificationsService í™•ì¥

**íŒŒì¼:** `nestjs_app/src/push-tokens/push-notifications.service.ts`

**ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€:**
```typescript
interface ContractNotificationPayload {
  userId: number;        // ì•Œë¦¼ ë°›ì„ ì‚¬ìš©ì ID (ê°‘/ì‘ì„±ì)
  title: string;         // ì•Œë¦¼ ì œëª©
  body: string;          // ì•Œë¦¼ ë‚´ìš©
  contractId: number;    // ê³„ì•½ì„œ ID
  contractName: string;  // ê³„ì•½ì„œ ì´ë¦„
}
```

**ë©”ì„œë“œ ì¶”ê°€:**
```typescript
async sendContractCompletedNotification(payload: ContractNotificationPayload) {
  if (!this.initialized) {
    this.logger.debug('FCMì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í‘¸ì‹œ ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
    return;
  }

  // ì‚¬ìš©ìì˜ FCM í† í° ì¡°íšŒ
  const tokens = await this.pushTokensService.findTokensByUserIds([
    payload.userId,
  ]);

  if (!tokens.length) {
    this.logger.debug('ë“±ë¡ëœ FCM í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const trimmedBody =
    payload.body.length > 128
      ? `${payload.body.slice(0, 125)}...`
      : payload.body;

  const authClient = await this.googleAuth.getClient();
  const projectId =
    this.configuredProjectId ?? (await this.googleAuth.getProjectId());

  if (!projectId) {
    this.logger.error('FCM í”„ë¡œì íŠ¸ IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const url = `https://fcm.googleapis.com/v1/projects/${projectId}/messages:send`;
  const invalidTokens: string[] = [];
  let successCount = 0;

  const results = await Promise.allSettled(
    tokens.map(async (token) => {
      try {
        await authClient.request({
          url,
          method: 'POST',
          data: {
            message: {
              token: token.token,
              notification: {
                title: payload.title,
                body: trimmedBody,
              },
              data: {
                type: 'contract_completed',
                contractId: payload.contractId.toString(),
                contractName: payload.contractName,
              },
              android: {
                priority: 'high',
                notification: {
                  channelId: 'contract_updates',
                  sound: 'default',
                },
              },
              apns: {
                payload: {
                  aps: {
                    sound: 'default',
                    'content-available': 1,
                  },
                },
              },
            },
          },
        });
        successCount++;
      } catch (error: any) {
        const errorCode = error?.response?.data?.error?.status;
        this.logger.warn(
          `í‘¸ì‹œ ì „ì†¡ ì‹¤íŒ¨ (token: ${token.token.slice(0, 20)}...): ${errorCode}`,
        );

        if (this.isUnrecoverableError(errorCode)) {
          invalidTokens.push(token.token);
        }

        throw error;
      }
    }),
  );

  // ìœ íš¨í•˜ì§€ ì•Šì€ í† í° ì œê±°
  if (invalidTokens.length > 0) {
    await this.pushTokensService.removeTokens(invalidTokens);
    this.logger.log(`${invalidTokens.length}ê°œì˜ ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.`);
  }

  const failureCount = results.filter((r) => r.status === 'rejected').length;

  this.logger.log(
    `ê³„ì•½ì„œ ì™„ë£Œ í‘¸ì‹œ ì „ì†¡: ì„±ê³µ ${successCount}, ì‹¤íŒ¨ ${failureCount}`,
  );

  return {
    success: successCount > 0,
    sent: successCount,
    failed: failureCount,
  };
}
```

#### 2) ContractsService ìˆ˜ì •

**íŒŒì¼:** `nestjs_app/src/contracts/contracts.service.ts`

**Import ì¶”ê°€:**
```typescript
import { PushNotificationsService } from "../push-tokens/push-notifications.service";
```

**Constructorì— ì˜ì¡´ì„± ì£¼ì…:**
```typescript
constructor(
  @InjectRepository(Contract)
  private readonly contractsRepository: Repository<Contract>,
  @InjectRepository(ContractMailLog)
  private readonly mailLogRepository: Repository<ContractMailLog>,
  @InjectRepository(Template)
  private readonly templatesRepository: Repository<Template>,
  private readonly mailService: MailService,
  private readonly configService: ConfigService,
  private readonly encryptionService: EncryptionService,
  private readonly pushNotificationsService: PushNotificationsService,  // ì¶”ê°€
) {}
```

**completeSignature ë©”ì„œë“œì— í‘¸ì‹œ ì•Œë¦¼ ë¡œì§ ì¶”ê°€:**
```typescript
async completeSignature(signatureToken: string, dto: CompleteSignatureDto) {
  const contract = await this.fetchContractBySignatureToken(signatureToken);

  // ... ê¸°ì¡´ ë¡œì§ (ì„œëª… ì´ë¯¸ì§€ ì €ì¥, ìƒíƒœ ì—…ë°ì´íŠ¸ ë“±) ...

  const saved = await this.contractsRepository.save(contract);
  const decrypted = this.decryptContractFields(saved);

  // ì„œëª… ì™„ë£Œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ (ê°‘/ì‘ì„±ìì—ê²Œ)
  if (saved.createdByUserId) {
    try {
      await this.pushNotificationsService.sendContractCompletedNotification({
        userId: saved.createdByUserId,
        title: 'ê³„ì•½ì„œ ì„œëª… ì™„ë£Œ',
        body: `${saved.performerName || 'ìˆ˜í–‰ì'}ë‹˜ì´ "${saved.name}" ê³„ì•½ì„œì— ì„œëª…í–ˆìŠµë‹ˆë‹¤.`,
        contractId: saved.id,
        contractName: saved.name,
      });
    } catch (error) {
      // í‘¸ì‹œ ì•Œë¦¼ ì‹¤íŒ¨ëŠ” ë¬´ì‹œ (ê³„ì•½ì„œ ì €ì¥ì€ ì„±ê³µ)
      console.error('í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
    }
  }

  return this.enrichTemplateMetadata(decrypted);
}
```

#### 3) ContractsModule ìˆ˜ì •

**íŒŒì¼:** `nestjs_app/src/contracts/contracts.module.ts`

**Import ì¶”ê°€:**
```typescript
import { PushTokensModule } from "../push-tokens/push-tokens.module";
```

**imports ë°°ì—´ì— ì¶”ê°€:**
```typescript
@Module({
  imports: [
    TypeOrmModule.forFeature([Contract, ContractMailLog, Template]),
    ConfigModule,
    MailModule,
    TemplatesModule,
    PushTokensModule,  // ì¶”ê°€
    JwtModule.registerAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        secret: config.get<string>("JWT_SECRET", "dev-secret"),
      }),
    }),
  ],
  providers: [ContractsService, ContractPdfService, EncryptionService],
  controllers: [ContractsController],
  exports: [ContractsService, ContractPdfService],
})
export class ContractsModule {}
```

### ë™ì‘ ë°©ì‹

```
[ì„œëª… ì™„ë£Œ í”Œë¡œìš°]

1. ê°‘(í™ê¸¸ë™)ì´ ê³„ì•½ì„œ ì‘ì„± ë° ì„œëª…
   â†“
2. ì„(ê¹€ì˜í¬)ì—ê²Œ ì„œëª… ìš”ì²­ ì´ë©”ì¼ ë°œì†¡
   â†“
3. ì„(ê¹€ì˜í¬)ì´ ì„œëª… ë§í¬ í´ë¦­
   â†“
4. ì„(ê¹€ì˜í¬)ì´ ì„œëª… ì™„ë£Œ
   â†“
5. CompleteSignature API í˜¸ì¶œ
   â†“
6. ê³„ì•½ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ (status: 'signature_completed')
   â†“
7. PushNotificationsService.sendContractCompletedNotification() í˜¸ì¶œ
   â†“
8. ê°‘(í™ê¸¸ë™)ì˜ FCM í† í° ì¡°íšŒ
   â†“
9. Firebase Cloud Messagingì„ í†µí•´ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
   â†“
10. ğŸ”” ê°‘(í™ê¸¸ë™)ì˜ í°ì— ì•Œë¦¼ ë„ì°©!
    "ê¹€ì˜í¬ë‹˜ì´ 'í”„ë¦¬ëœì„œ ê³„ì•½ì„œ'ì— ì„œëª…í–ˆìŠµë‹ˆë‹¤."
```

### ì•Œë¦¼ ë°ì´í„° êµ¬ì¡°

```json
{
  "notification": {
    "title": "ê³„ì•½ì„œ ì„œëª… ì™„ë£Œ",
    "body": "ê¹€ì˜í¬ë‹˜ì´ 'í”„ë¦¬ëœì„œ ê³„ì•½ì„œ'ì— ì„œëª…í–ˆìŠµë‹ˆë‹¤."
  },
  "data": {
    "type": "contract_completed",
    "contractId": "123",
    "contractName": "í”„ë¦¬ëœì„œ ê³„ì•½ì„œ"
  },
  "android": {
    "priority": "high",
    "notification": {
      "channelId": "contract_updates",
      "sound": "default"
    }
  },
  "apns": {
    "payload": {
      "aps": {
        "sound": "default",
        "content-available": 1
      }
    }
  }
}
```

### Flutter ì•±ì—ì„œì˜ ì²˜ë¦¬

**í˜„ì¬ ìƒíƒœ:**
- `push_notification_service.dart`ì— `onMessage`, `onMessageOpenedApp` ë¦¬ìŠ¤ë„ˆ ì¡´ì¬
- ì•Œë¦¼ ìˆ˜ì‹  ë° ë¡œì»¬ ì•Œë¦¼ í‘œì‹œëŠ” ì‘ë™
- ì•Œë¦¼ íƒ­ ì‹œ ê³„ì•½ì„œ ìƒì„¸ë¡œ ì´ë™í•˜ëŠ” ë¡œì§ì€ ì•„ì§ ì—†ìŒ

**í–¥í›„ ê°œì„  ë°©í–¥:**
```dart
// push_notification_service.dart
FirebaseMessaging.onMessageOpenedApp.listen((message) {
  final data = message.data;

  if (data['type'] == 'contract_completed') {
    final contractId = data['contractId'];
    // GlobalNavigatorKeyë¥¼ ì‚¬ìš©í•˜ì—¬ ê³„ì•½ì„œ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
    navigatorKey.currentState?.push(
      MaterialPageRoute(
        builder: (_) => ContractDetailScreen(contractId: int.parse(contractId)),
      ),
    );
  }
});
```

### ê²°ê³¼
âœ… ì„(ìˆ˜í–‰ì)ì´ ì„œëª… ì™„ë£Œ ì‹œ ê°‘(ì‘ì„±ì)ì—ê²Œ ì¦‰ì‹œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
âœ… ì•Œë¦¼ ê¶Œí•œ ì²´í¬ í¬í•¨ (NotificationPreferencesService)
âœ… ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨í•´ë„ ê³„ì•½ì„œ ì €ì¥ì€ ì •ìƒ ì§„í–‰
âœ… ë¡œê·¸ë¡œ ì „ì†¡ ì„±ê³µ/ì‹¤íŒ¨ ì¶”ì  ê°€ëŠ¥
âš ï¸ ì•Œë¦¼ íƒ­ ì‹œ ê³„ì•½ì„œ ìƒì„¸ë¡œ ì´ë™ ê¸°ëŠ¥ì€ í–¥í›„ ì¶”ê°€ í•„ìš”

---

## ğŸ“Š ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### Backend (NestJS)
1. `nestjs_app/src/scripts/update-consent-template-simple.ts`
   - ì„œëª… í”Œë ˆì´ìŠ¤í™€ë” ë³€ê²½
   - í•„ë“œëª… í‘œì¤€í™”
   - samplePayload ì—…ë°ì´íŠ¸

2. `nestjs_app/src/push-tokens/push-notifications.service.ts`
   - ContractNotificationPayload ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€
   - sendContractCompletedNotification ë©”ì„œë“œ ì¶”ê°€

3. `nestjs_app/src/contracts/contracts.service.ts`
   - PushNotificationsService import
   - Constructorì— ì˜ì¡´ì„± ì£¼ì…
   - completeSignatureì— í‘¸ì‹œ ì•Œë¦¼ ë¡œì§ ì¶”ê°€

4. `nestjs_app/src/contracts/contracts.module.ts`
   - PushTokensModule import ë° ì¶”ê°€

### Frontend (Flutter)
5. `insign_flutter/lib/features/contracts/view/create_contract_screen.dart`
   - flutter_bloc, AuthCubit import ì¶”ê°€
   - _loadUserInfo ë©”ì„œë“œ ì¶”ê°€
   - initStateì—ì„œ _loadUserInfo í˜¸ì¶œ

### Documentation
6. `/home/insign/ì•±_ê°œì„ ì•ˆ_ë¶„ì„_2025-11-27.md` (ì‹ ê·œ ìƒì„±)
   - ì¢…í•© ì•± ê°œì„ ì•ˆ ë¶„ì„ ë¬¸ì„œ

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ í™•ì¸
```bash
# ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
sudo mysql -u root -p'H./Bv!jPsH*z-[Jo' insign -e "SELECT id, name FROM templates WHERE id = 6;"
sudo mysql -u root -p'H./Bv!jPsH*z-[Jo' insign -e "SELECT content FROM templates WHERE id = 6;" 2>/dev/null | grep -o "{{[^}]*}}" | sort -u
```

**ì˜ˆìƒ ê²°ê³¼:**
- `{{clientName}}`, `{{clientEmail}}`, `{{clientContact}}`
- `{{performerName}}`, `{{performerEmail}}`, `{{performerContact}}`
- `{{authorSignature}}`, `{{performerSignature}}`

### 2. ì‚¬ìš©ì ì •ë³´ ìë™ ì±„ìš°ê¸° í…ŒìŠ¤íŠ¸
```
1. Flutter ì•± ì‹¤í–‰
2. ë¡œê·¸ì¸ (displayName, emailì´ ìˆëŠ” ê³„ì •)
3. ê³„ì•½ì„œ ì‘ì„± í™”ë©´ ì§„ì…
4. ê°‘(ì‘ì„±ì) ì´ë¦„ê³¼ ì´ë©”ì¼ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì ¸ ìˆëŠ”ì§€ í™•ì¸
```

### 3. í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸
```
1. NestJS ì„œë²„ ì¬ì‹œì‘
   cd /home/insign/nestjs_app
   npm run start:dev

2. A ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ (ê°‘/ì‘ì„±ì)
3. ê³„ì•½ì„œ ì‘ì„± ë° ì„œëª…
4. B ì‚¬ìš©ì(ì„/ìˆ˜í–‰ì) ì´ë©”ì¼ë¡œ ì„œëª… ìš”ì²­
5. B ì‚¬ìš©ìê°€ ì„œëª… ë§í¬ í´ë¦­ ë° ì„œëª… ì™„ë£Œ
6. A ì‚¬ìš©ì í°ì— í‘¸ì‹œ ì•Œë¦¼ ë„ì°© í™•ì¸
   - ì œëª©: "ê³„ì•½ì„œ ì„œëª… ì™„ë£Œ"
   - ë‚´ìš©: "B ì‚¬ìš©ìë‹˜ì´ 'ê³„ì•½ì„œëª…'ì— ì„œëª…í–ˆìŠµë‹ˆë‹¤."
```

---

## ğŸ“ˆ ì„±ê³¼

### ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- âœ… ì„œëª… ì´ë¯¸ì§€ ì •ìƒ í‘œì‹œ (ì„±ê´€ê³„ ë™ì˜ì„œ)
- âœ… ê³„ì•½ì„œ ì‘ì„± ì‹œ ì´ë¦„/ì´ë©”ì¼ ìë™ ì…ë ¥
- âœ… ì„œëª… ì™„ë£Œ ì¦‰ì‹œ ì•Œë¦¼ ìˆ˜ì‹ 

### ì½”ë“œ í’ˆì§ˆ ê°œì„ 
- âœ… í…œí”Œë¦¿ í•„ë“œëª… í‘œì¤€í™” (ì¼ê´€ì„±)
- âœ… ì¤‘ë³µ ì½”ë“œ ì œê±° (Flutter ë§¤í•‘ ë¶ˆí•„ìš”)
- âœ… í‘¸ì‹œ ì•Œë¦¼ ì¸í”„ë¼ í™œìš©

### í–¥í›„ ê°œì„  ë°©í–¥
1. User ëª¨ë¸ì— phone í•„ë“œ ì¶”ê°€ â†’ ì—°ë½ì²˜ë„ ìë™ ì…ë ¥
2. ì•Œë¦¼ íƒ­ ì‹œ ê³„ì•½ì„œ ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
3. ì„œëª… ìš”ì²­ ì‹œì—ë„ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
4. ê³„ì•½ ë§Œë£Œ 7ì¼ ì „ ìë™ ì•Œë¦¼

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„ ì œì•ˆ

### ìš°ì„ ìˆœìœ„ ë†’ìŒ
1. **User ëª¨ë¸ì— phone í•„ë“œ ì¶”ê°€** (1ì¼)
   - Backend: users í…Œì´ë¸”ì— phone ì»¬ëŸ¼ ì¶”ê°€
   - Backend: íšŒì›ê°€ì…/í”„ë¡œí•„ ìˆ˜ì • API ì—…ë°ì´íŠ¸
   - Frontend: User ëª¨ë¸ì— phone í•„ë“œ ì¶”ê°€
   - Frontend: í”„ë¡œí•„ í™”ë©´ì— ì—°ë½ì²˜ ì…ë ¥ í•„ë“œ ì¶”ê°€

2. **í† í° ì•”í˜¸í™”** (1ì¼)
   - flutter_secure_storage íŒ¨í‚¤ì§€ ì¶”ê°€
   - SessionServiceë¥¼ SecureStorageë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜

3. **ê³„ì•½ì„œ ê²€ìƒ‰ ê°œì„ ** (1ì£¼)
   - ì „ì²´ í…ìŠ¤íŠ¸ ê²€ìƒ‰
   - ë‚ ì§œ/ê¸ˆì•¡ ë²”ìœ„ í•„í„°
   - ë‹¤ì¤‘ ìƒíƒœ ì„ íƒ

### ìš°ì„ ìˆœìœ„ ì¤‘ê°„
4. **ì•Œë¦¼ íƒ­ ì‹œ í™”ë©´ ì´ë™** (2ì¼)
   - GlobalNavigatorKey ì„¤ì •
   - onMessageOpenedAppì—ì„œ ë¼ìš°íŒ…

5. **ì¼ê´„ ì‘ì—… ê¸°ëŠ¥** (1-2ì£¼)
   - PDF ì¼ê´„ ë‹¤ìš´ë¡œë“œ
   - ì¼ê´„ ë³´ê´€/ì‚­ì œ

---

## ğŸ’¡ íŠ¹ì´ì‚¬í•­ ë° ì£¼ì˜ì‚¬í•­

### 1. ê¸°ì¡´ ê³„ì•½ì„œ ì„œëª… ì´ë¯¸ì§€
- í…œí”Œë¦¿ í•„ë“œëª…ì„ ë³€ê²½í–ˆì§€ë§Œ, ì´ë¯¸ ì‘ì„±ëœ ê³„ì•½ì„œëŠ” ì˜í–¥ ì—†ìŒ
- ìƒˆë¡œ ì‘ì„±í•˜ëŠ” ê³„ì•½ì„œë¶€í„° ì ìš©ë¨

### 2. í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ ì²˜ë¦¬
- í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ì´ ì‹¤íŒ¨í•´ë„ ê³„ì•½ì„œ ì €ì¥ì€ ì •ìƒ ì§„í–‰
- try-catchë¡œ ì—ëŸ¬ë¥¼ ì¡ì•„ì„œ ê³„ì•½ì„œ ì €ì¥ì— ì˜í–¥ ì—†ë„ë¡ í•¨

### 3. FCM í† í° ê´€ë¦¬
- ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì€ ìë™ìœ¼ë¡œ ì œê±°ë¨
- í† í° ê°±ì‹ ì€ onTokenRefresh ë¦¬ìŠ¤ë„ˆì—ì„œ ìë™ ì²˜ë¦¬

### 4. ì•Œë¦¼ ê¶Œí•œ
- ì‚¬ìš©ìê°€ ì•Œë¦¼ì„ ê±°ë¶€í•˜ë©´ í‘¸ì‹œ ì „ì†¡ ì•ˆ ë¨
- NotificationPreferencesServiceë¡œ ê¶Œí•œ ì²´í¬

---

## ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€ (ì°¸ê³ ìš©)

```
feat: ì„±ê´€ê³„ ë™ì˜ì„œ ì„œëª… ì´ë¯¸ì§€ í‘œì‹œ ë° ìë™ ì…ë ¥ ê¸°ëŠ¥ ì¶”ê°€

- í…œí”Œë¦¿ í•„ë“œëª…ì„ í‘œì¤€ ì´ë¦„ìœ¼ë¡œ ë³€ê²½ (partyA/B â†’ client/performer)
- ì„œëª… í”Œë ˆì´ìŠ¤í™€ë” í‘œì¤€í™” (partyASignature â†’ authorSignature)
- ê³„ì•½ì„œ ì‘ì„± ì‹œ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ìë™ ì±„ìš°ê¸°
- ì„œëª… ì™„ë£Œ ì‹œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ ê¸°ëŠ¥ ì¶”ê°€

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## âœ… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ì„±ê´€ê³„ ë™ì˜ì„œ ì„œëª… ì´ë¯¸ì§€ í‘œì‹œ ë¬¸ì œ í•´ê²°
- [x] í…œí”Œë¦¿ í•„ë“œëª… í‘œì¤€í™”
- [x] ì‚¬ìš©ì ì •ë³´ ìë™ ì±„ìš°ê¸° ê¸°ëŠ¥ ì¶”ê°€
- [x] ì•± ê°œì„ ì•ˆ ì¢…í•© ë¶„ì„ ë¬¸ì„œ ì‘ì„±
- [x] ì„œëª… ì™„ë£Œ ì‹œ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€
- [x] ì‘ì—… ë‚´ì—­ ë¬¸ì„œ ì‘ì„±

---

**ì‘ì—… ì™„ë£Œ ì‹œê°:** 2025-11-27
**ì‘ì—…ì:** Claude Code Assistant
**ì†Œìš” ì‹œê°„:** ì•½ 2ì‹œê°„
