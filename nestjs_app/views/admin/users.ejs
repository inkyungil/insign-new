<% const activePage = 'users'; %>
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>가입자 관리</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@1.13.1/css/OverlayScrollbars.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" crossorigin="anonymous" />
  </head>
  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <%- include("partials/sidebar") %>

      <div class="content-wrapper">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1>가입자 관리</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item"><a href="/adm/dashboard">Home</a></li>
                  <li class="breadcrumb-item active">가입자 관리</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <section class="content">
          <div class="container-fluid">
              <div class="col-lg-12">
                <div class="card">
                  <div class="card-header border-0">
                    <h3 class="card-title">가입자 목록</h3>
                  </div>
                  <div class="card-body table-responsive p-0" style="max-height: 720px;">
                    <table class="table table-hover text-nowrap">
                      <thead>
                        <tr>
                          <th style="width: 60px">ID</th>
                          <th>이메일</th>
                          <th>이름</th>
                          <th style="width: 90px">가입 경로</th>
                          <th style="width: 90px">상태</th>
                          <th style="width: 120px">액션</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (!users.length) { %>
                        <tr>
                          <td colspan="6" class="text-center text-muted">등록된 사용자가 없습니다.</td>
                        </tr>
                        <% } %>
                        <% users.forEach(function (item) { %>
                        <tr data-user-id="<%= item.id %>" class="clickable-row">
                          <td class="font-weight-bold"><%= item.id %></td>
                          <td><%= item.email %></td>
                          <td><%= item.displayName %></td>
                          <td><span class="badge <%= item.provider === 'google' ? 'badge-info' : 'badge-secondary' %>"><%= item.providerLabel %></span></td>
                          <td>
                            <% if (item.isActive) { %>
                            <span class="badge badge-success">활성</span>
                            <% } else { %>
                            <span class="badge badge-secondary">비활성</span>
                            <% } %>
                          </td>
                          <td>
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-primary"
                              data-action="open-push-modal"
                              data-user-id="<%= item.id %>"
                              data-user-email="<%= item.email %>"
                              <%= item.pushTokenCount > 0 ? '' : 'disabled' %>
                            >
                              푸시 발송
                            </button>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
          </div>
        </section>
      </div>

      <footer class="main-footer">
        <strong>인싸인 Admin</strong>
        <div class="float-right d-none d-sm-inline">총 가입자: <%= users.length %>명</div>
      </footer>
    </div>

    <div
      class="modal fade"
      id="pushModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="pushModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pushModalLabel">푸시 메시지 발송</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-3">
              수신자: <strong id="push-target-label">-</strong>
            </p>
            <div id="push-feedback" class="alert d-none" role="alert"></div>
            <form id="push-form" data-user-id="">
              <div class="form-group">
                <label for="push-category">카테고리</label>
                <select class="form-control" id="push-category" name="category">
                  <option value="general">일반 알림</option>
                  <option value="contract">계약 진행 알림</option>
                </select>
              </div>
              <div class="form-group">
                <label for="push-title">제목</label>
                <input
                  type="text"
                  class="form-control"
                  id="push-title"
                  name="title"
                  required
                  maxlength="120"
                  placeholder="알림 제목"
                />
              </div>
              <div class="form-group mb-0">
                <label for="push-body">메시지</label>
                <textarea
                  class="form-control"
                  id="push-body"
                  name="body"
                  rows="3"
                  required
                  maxlength="500"
                  placeholder="발송할 메시지를 입력하세요."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
            <button type="submit" form="push-form" class="btn btn-primary">
              <i class="fas fa-paper-plane mr-1"></i> 발송
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="userDetailModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="userDetailModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userDetailModalLabel">가입자 상세 정보</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="user-detail-content">
              <p class="text-center text-muted">사용자 정보를 불러오는 중...</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
          </div>
        </div>
      </div>
    </div>

    <form id="logout-form" method="post" action="/adm/logout" style="display: none;"></form>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@1.13.1/js/jquery.overlayScrollbars.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js" crossorigin="anonymous"></script>
    <style>
      .clickable-row {
        cursor: pointer;
      }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Logout
        document.querySelectorAll('[data-action="logout"]').forEach(function (el) {
          el.addEventListener('click', function (event) {
            event.preventDefault();
            document.getElementById('logout-form').submit();
          });
        });

        // Push Modal
        var pushForm = document.getElementById('push-form');
        var pushModal = document.getElementById('pushModal');
        var pushFeedback = document.getElementById('push-feedback');
        var pushTitleInput = document.getElementById('push-title');
        var pushBodyInput = document.getElementById('push-body');
        var pushTargetLabel = document.getElementById('push-target-label');
        var pushCategorySelect = document.getElementById('push-category');

        function openPushModal(userId, email) {
          if (!pushForm) return;
          pushForm.setAttribute('data-user-id', userId);
          if (pushFeedback) {
            pushFeedback.className = 'alert d-none';
            pushFeedback.textContent = '';
          }
          if (pushTitleInput) pushTitleInput.value = '';
          if (pushBodyInput) pushBodyInput.value = '';
          if (pushTargetLabel) pushTargetLabel.textContent = email + ' (ID ' + userId + ')';
          if (pushCategorySelect) pushCategorySelect.value = 'general';
          if (window.jQuery && pushModal) window.jQuery(pushModal).modal('show');
        }

        document.querySelectorAll('[data-action="open-push-modal"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var userId = btn.getAttribute('data-user-id');
            var email = btn.getAttribute('data-user-email') || '사용자';
            openPushModal(userId, email);
          });
        });
        
        if (pushForm) {
            pushForm.addEventListener('submit', function (event) {
            event.preventDefault();
            if (!pushTitleInput || !pushBodyInput) return;
            var title = pushTitleInput.value.trim();
            var body = pushBodyInput.value.trim();
            var category = pushCategorySelect ? pushCategorySelect.value : 'general';
            if (!title || !body) {
                if (pushFeedback) {
                pushFeedback.className = 'alert alert-danger';
                pushFeedback.textContent = '제목과 메시지를 모두 입력하세요.';
                }
                return;
            }
            if (!category) {
                if (pushFeedback) {
                pushFeedback.className = 'alert alert-danger';
                pushFeedback.textContent = '카테고리를 선택하세요.';
                }
                return;
            }
            var userId = pushForm.getAttribute('data-user-id');
            if (!userId) {
                if (pushFeedback) {
                pushFeedback.className = 'alert alert-danger';
                pushFeedback.textContent = '대상 사용자를 찾을 수 없습니다.';
                }
                return;
            }

            fetch('/adm/users/' + userId + '/push', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ category: category, title: title, body: body }),
            })
            .then(function (response) {
                return response.json().then(function (payload) {
                    return { ok: response.ok, status: response.status, data: payload };
                }).catch(function () {
                    return { ok: response.ok, status: response.status, data: null };
                });
            })
            .then(function (result) {
                var message = '';
                if (result.ok) {
                    message = result.data?.message || '푸시 메시지를 발송했습니다.';
                } else {
                    // Extract error message from validation errors or general message
                    if (result.data?.message) {
                        if (Array.isArray(result.data.message)) {
                            message = result.data.message.join(', ');
                        } else {
                            message = result.data.message;
                        }
                    } else {
                        message = '푸시 메시지 전송에 실패했습니다.';
                    }
                }

                if (pushFeedback) {
                    pushFeedback.className = 'alert ' + (result.ok ? 'alert-success' : 'alert-danger');
                    pushFeedback.textContent = message;
                } else {
                    alert(message);
                }

                if (result.ok) {
                    pushTitleInput.value = '';
                    pushBodyInput.value = '';
                    if (window.jQuery && pushModal) {
                        setTimeout(function () { window.jQuery(pushModal).modal('hide'); }, 600);
                    }
                }
            })
            .catch(function (error) {
                if (pushFeedback) {
                    pushFeedback.className = 'alert alert-danger';
                    pushFeedback.textContent = '푸시 메시지 전송 중 오류가 발생했습니다: ' + (error.message || '');
                } else {
                    alert('푸시 메시지 전송 중 오류가 발생했습니다.');
                }
            });
            });
        }
        
        // User Detail Modal
        var userDetailModal = document.getElementById('userDetailModal');
        var userDetailContent = document.getElementById('user-detail-content');

        function openUserDetailModal(userId) {
          if (!userDetailModal || !userDetailContent) return;

          userDetailContent.innerHTML = '<p class="text-center text-muted">사용자 정보를 불러오는 중...</p>';
          if (window.jQuery) window.jQuery(userDetailModal).modal('show');

          fetch('/adm/users/' + userId + '/json')
            .then(function (response) {
              if (!response.ok) throw new Error('사용자 정보를 불러오는데 실패했습니다.');
              return response.json();
            })
            .then(function (user) {
              renderUserDetails(user);
            })
            .catch(function (error) {
              userDetailContent.innerHTML = '<p class="text-center text-danger">' + error.message + '</p>';
            });
        }
        
        function renderUserDetails(user) {
            var content = `
                <dl class="row">
                <dt class="col-sm-4">이메일</dt>
                <dd class="col-sm-8">${user.email}</dd>
                <dt class="col-sm-4">이름</dt>
                <dd class="col-sm-8">${user.displayName}</dd>
                <dt class="col-sm-4">가입 경로</dt>
                <dd class="col-sm-8"><span class="badge ${user.provider === 'google' ? 'badge-info' : 'badge-secondary'}">${user.providerLabel}</span></dd>
                <dt class="col-sm-4">상태</dt>
                <dd class="col-sm-8">${user.isActive ? '<span class="badge badge-success">활성</span>' : '<span class="badge badge-secondary">비활성</span>'}</dd>
                <dt class="col-sm-4">가입일</dt>
                <dd class="col-sm-8">${user.createdAt}</dd>
                <dt class="col-sm-4">최근 수정</dt>
                <dd class="col-sm-8">${user.updatedAt}</dd>
                <dt class="col-sm-4">마지막 로그인</dt>
                <dd class="col-sm-8">${user.lastLoginAt}</dd>
                ${user.googleId ? `<dt class="col-sm-4">Google ID</dt><dd class="col-sm-8"><span class="text-monospace">${user.googleId}</span></dd>` : ''}
                </dl>
                <hr>
                <h5 class="font-weight-bold d-flex align-items-center">푸시 토큰 현황 <span class="badge badge-secondary ml-2">${user.pushTokenCount}개</span></h5>
            `;

            if (user.pushTokens && user.pushTokens.length) {
                content += `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                        <th style="width: 80px;">ID</th>
                        <th style="width: 90px;">플랫폼</th>
                        <th>토큰</th>
                        <th style="width: 160px;">최근 사용</th>
                        <th style="width: 160px;">등록/갱신</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${user.pushTokens.map(token => `
                        <tr>
                            <td>${token.id}</td>
                            <td><span class="badge badge-light border">${token.platform}</span></td>
                            <td class="text-monospace" style="max-width: 220px;">
                            <span title="${token.token}">${token.token.length > 32 ? token.token.slice(0, 32) + '…' : token.token}</span>
                            </td>
                            <td><small class="text-muted">${token.lastSeenAt}</small></td>
                            <td><small class="text-muted">${token.updatedAt}</small></td>
                        </tr>
                        `).join('')}
                    </tbody>
                    </table>
                </div>
                `;
            } else {
                content += '<p class="text-muted">등록된 푸시 토큰이 없습니다.</p>';
            }

            content += `
                <hr>
                <h5 class="font-weight-bold">비밀번호 재설정</h5>
                <p class="text-muted mb-3">새 비밀번호를 입력하면 즉시 업데이트됩니다. 최소 8자 이상 입력하세요.</p>
                <form id="password-reset-form" method="post" action="/adm/users/${user.id}/password">
                <div class="form-group">
                    <label for="new-password">새 비밀번호</label>
                    <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-key"></i></span></div>
                    <input type="password" name="password" id="new-password" class="form-control" required minlength="8" placeholder="새 비밀번호" />
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"><i class="fas fa-sync-alt mr-1"></i> 비밀번호 변경</button>
                </form>
            `;
            
            userDetailContent.innerHTML = content;
            
            var passwordForm = document.getElementById('password-reset-form');
            if (passwordForm) {
                passwordForm.addEventListener('submit', function(event) {
                event.preventDefault();
                var password = passwordForm.querySelector('#new-password').value;
                if (password.trim().length < 8) {
                    alert('비밀번호는 8자 이상 입력해 주세요.');
                    return;
                }

                fetch('/adm/users/' + user.id + '/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ password: password.trim() })
                }).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    alert(data.message);
                    if (window.jQuery) window.jQuery(userDetailModal).modal('hide');
                }).catch(function() {
                    alert('비밀번호 변경 중 오류가 발생했습니다.');
                });
                });
            }
        }

        document.querySelectorAll('.clickable-row').forEach(function (row) {
            row.addEventListener('click', function (event) {
                if (event.target.closest('button')) return;
                var userId = row.getAttribute('data-user-id');
                openUserDetailModal(userId);
            });
        });
      });
    </script>
  </body>
</html>
