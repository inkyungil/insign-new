<% const activePage = 'plans'; %>
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>요금제 관리</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@1.13.1/css/OverlayScrollbars.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" crossorigin="anonymous" />
  </head>
  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <%- include("partials/sidebar") %>

      <div class="content-wrapper">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1>요금제 관리</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item"><a href="/adm/dashboard">Home</a></li>
                  <li class="breadcrumb-item active">요금제 관리</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <section class="content">
          <div class="container-fluid">
            <% if (successMessage) { %>
            <div class="alert alert-success"><i class="fas fa-check mr-2"></i><%= successMessage %></div>
            <% } %>
            <% if (errorMessage) { %>
            <div class="alert alert-danger"><i class="fas fa-exclamation-circle mr-2"></i><%= errorMessage %></div>
            <% } %>

            <div class="row">
              <div class="col-lg-7">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">요금제 목록</h3>
                    <a href="/adm/plans" class="btn btn-sm btn-outline-secondary">목록 새로고침</a>
                  </div>
                  <div class="card-body table-responsive p-0" style="max-height: 520px;">
                    <table class="table table-hover text-nowrap">
                      <thead>
                        <tr>
                          <th style="width: 60px;">ID</th>
                          <th>이름/티어</th>
                          <th style="width: 120px;">월 요금</th>
                          <th style="width: 110px;">계약 한도</th>
                          <th style="width: 110px;">포인트 한도</th>
                          <th style="width: 90px;">활성</th>
                          <th style="width: 90px;">순서</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (!plans || !plans.length) { %>
                        <tr>
                          <td colspan="7" class="text-center text-muted">등록된 요금제가 없습니다.</td>
                        </tr>
                        <% } %>
                        <% (plans || []).forEach(function (plan) { %>
                        <tr class="<%= plan.isSelected ? 'table-primary' : '' %>">
                          <td>
                            <a href="/adm/plans/<%= plan.id %>" class="font-weight-bold">#<%= plan.id %></a>
                          </td>
                          <td>
                            <strong><%= plan.name %></strong>
                            <div class="text-muted">Tier: <%= plan.tier %></div>
                          </td>
                          <td><%= plan.priceMonthly.toLocaleString('ko-KR') %>원</td>
                          <td>
                            <% if (plan.contracts === -1) { %>
                            무제한
                            <% } else { %>
                            월 <%= plan.contracts %>건
                            <% } %>
                          </td>
                          <td>
                            <% if (plan.points === -1) { %>
                            무제한
                            <% } else { %>
                            월 <%= plan.points %>P
                            <% } %>
                          </td>
                          <td>
                            <% if (plan.isActive) { %>
                            <span class="badge badge-success">ON</span>
                            <% } else { %>
                            <span class="badge badge-secondary">OFF</span>
                            <% } %>
                          </td>
                          <td><%= plan.displayOrder %></td>
                        </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="col-lg-5">
                <div class="card card-outline card-primary">
                  <div class="card-header">
                    <h3 class="card-title mb-0">선택한 요금제</h3>
                  </div>
                  <div class="card-body">
                    <% if (!selectedPlan) { %>
                    <p class="text-muted mb-0">좌측 목록에서 요금제를 선택하면 상세 정보를 확인하고 수정할 수 있습니다.</p>
                    <% } else { %>
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <strong class="d-block"><%= selectedPlan.name %></strong>
                          <small class="text-muted">Tier: <%= selectedPlan.tier %></small>
                        </div>
                        <span class="badge <%= selectedPlan.isActive ? 'badge-success' : 'badge-secondary' %>">
                          <%= selectedPlan.isActive ? '활성' : '비활성' %>
                        </span>
                      </div>
                    </div>

                    <dl class="row mb-0">
                      <dt class="col-5">계약 한도</dt>
                      <dd class="col-7"><%= selectedPlan.monthlyContractLimit === -1 ? '무제한' : selectedPlan.monthlyContractLimit + '건' %></dd>
                      <dt class="col-5">포인트 한도</dt>
                      <dd class="col-7"><%= selectedPlan.monthlyPointsLimit === -1 ? '무제한' : selectedPlan.monthlyPointsLimit + 'P' %></dd>
                      <dt class="col-5">초기 포인트</dt>
                      <dd class="col-7"><%= selectedPlan.initialPoints %>P</dd>
                      <dt class="col-5">월 구독료</dt>
                      <dd class="col-7"><%= selectedPlan.priceMonthly.toLocaleString('ko-KR') %>원</dd>
                      <dt class="col-5">연 구독료</dt>
                      <dd class="col-7"><%= selectedPlan.priceYearly ? selectedPlan.priceYearly.toLocaleString('ko-KR') + '원' : '-' %></dd>
                      <dt class="col-5">등록/수정</dt>
                      <dd class="col-7"><small><%= selectedPlan.createdAt %> / <%= selectedPlan.updatedAt %></small></dd>
                    </dl>

                    <hr />
                    <form method="post" action="/adm/plans/<%= selectedPlan.id %>">
                      <div class="form-group">
                        <label>요금제 이름</label>
                        <input type="text" name="name" class="form-control form-control-sm" value="<%= selectedPlan.name %>" required />
                      </div>
                      <div class="form-group">
                        <label>티어 (고유)</label>
                        <input type="text" name="tier" class="form-control form-control-sm" value="<%= selectedPlan.tier %>" required />
                      </div>
                      <div class="form-group">
                        <label>설명</label>
                        <textarea class="form-control form-control-sm" name="description" rows="3" placeholder="요금제 설명"><%= selectedPlan.description %></textarea>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label>월 계약 한도 (-1 무제한)</label>
                          <input type="number" name="monthlyContractLimit" class="form-control form-control-sm" value="<%= selectedPlan.monthlyContractLimit %>" />
                        </div>
                        <div class="form-group col-md-6">
                          <label>월 포인트 한도 (-1 무제한)</label>
                          <input type="number" name="monthlyPointsLimit" class="form-control form-control-sm" value="<%= selectedPlan.monthlyPointsLimit %>" />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-4">
                          <label>초기 포인트</label>
                          <input type="number" name="initialPoints" class="form-control form-control-sm" value="<%= selectedPlan.initialPoints %>" />
                        </div>
                        <div class="form-group col-md-4">
                          <label>월 요금(원)</label>
                          <input type="number" name="priceMonthly" class="form-control form-control-sm" value="<%= selectedPlan.priceMonthly %>" min="0" />
                        </div>
                        <div class="form-group col-md-4">
                          <label>연 요금(원)</label>
                          <input type="number" name="priceYearly" class="form-control form-control-sm" value="<%= selectedPlan.priceYearly %>" min="0" />
                        </div>
                      </div>
                      <div class="form-group">
                        <label>표시 순서</label>
                        <input type="number" name="displayOrder" class="form-control form-control-sm" value="<%= selectedPlan.displayOrder %>" />
                      </div>
                      <div class="form-group">
                        <label>features (JSON)</label>
                        <textarea class="form-control form-control-sm" name="features" rows="4" placeholder='{"ai": true}'><%= selectedPlan.featuresText %></textarea>
                      </div>
                      <div class="custom-control custom-switch mb-3">
                        <input type="hidden" name="isActive" value="off" />
                        <input type="checkbox" class="custom-control-input" id="planActiveSwitch" name="isActive" value="on" <%= selectedPlan.isActive ? 'checked' : '' %> />
                        <label class="custom-control-label" for="planActiveSwitch">활성화</label>
                      </div>
                      <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                          <i class="fas fa-save mr-1"></i> 저장
                        </button>
                        <button
                          type="submit"
                          form="delete-plan-form"
                          class="btn btn-outline-danger"
                          onclick="return confirm('정말로 삭제하시겠습니까?');"
                        >
                          <i class="fas fa-trash mr-1"></i> 삭제
                        </button>
                      </div>
                    </form>
                    <form id="delete-plan-form" method="post" action="/adm/plans/<%= selectedPlan.id %>/delete"></form>
                    <% } %>
                  </div>
                </div>

                <div class="card card-outline card-secondary">
                  <div class="card-header">
                    <h3 class="card-title mb-0">새 요금제 등록</h3>
                  </div>
                  <div class="card-body">
                    <form method="post" action="/adm/plans">
                      <div class="form-group">
                        <label>요금제 이름</label>
                        <input type="text" name="name" class="form-control form-control-sm" value="<%= defaultForm.name %>" required />
                      </div>
                      <div class="form-group">
                        <label>티어 (고유, 예: free, premium)</label>
                        <input type="text" name="tier" class="form-control form-control-sm" value="<%= defaultForm.tier %>" required />
                      </div>
                      <div class="form-group">
                        <label>설명</label>
                        <textarea class="form-control form-control-sm" name="description" rows="2" placeholder="요금제 설명"></textarea>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label>월 계약 한도 (-1 무제한)</label>
                          <input type="number" name="monthlyContractLimit" class="form-control form-control-sm" value="<%= defaultForm.monthlyContractLimit %>" required />
                        </div>
                        <div class="form-group col-md-6">
                          <label>월 포인트 한도 (-1 무제한)</label>
                          <input type="number" name="monthlyPointsLimit" class="form-control form-control-sm" value="<%= defaultForm.monthlyPointsLimit %>" required />
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-4">
                          <label>초기 포인트</label>
                          <input type="number" name="initialPoints" class="form-control form-control-sm" value="<%= defaultForm.initialPoints %>" required />
                        </div>
                        <div class="form-group col-md-4">
                          <label>월 요금(원)</label>
                          <input type="number" name="priceMonthly" class="form-control form-control-sm" value="<%= defaultForm.priceMonthly %>" min="0" required />
                        </div>
                        <div class="form-group col-md-4">
                          <label>연 요금(원)</label>
                          <input type="number" name="priceYearly" class="form-control form-control-sm" min="0" />
                        </div>
                      </div>
                      <div class="form-group">
                        <label>표시 순서</label>
                        <input type="number" name="displayOrder" class="form-control form-control-sm" value="0" />
                      </div>
                      <div class="form-group">
                        <label>features (JSON)</label>
                        <textarea class="form-control form-control-sm" name="features" rows="3" placeholder='{"ai": true}'></textarea>
                      </div>
                      <div class="custom-control custom-switch mb-3">
                        <input type="hidden" name="isActive" value="off" />
                        <input type="checkbox" class="custom-control-input" id="newPlanActive" name="isActive" value="on" checked />
                        <label class="custom-control-label" for="newPlanActive">활성화</label>
                      </div>
                      <button type="submit" class="btn btn-secondary btn-block">
                        <i class="fas fa-plus-circle mr-1"></i> 요금제 생성
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <form id="logout-form" method="post" action="/adm/logout" style="display: none;"></form>

      <footer class="main-footer text-sm">
        <strong>ⓒ 인싸인 Admin</strong>
        <div class="float-right d-none d-sm-inline">요금제 구성 관리</div>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@1.13.1/js/jquery.overlayScrollbars.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js" crossorigin="anonymous"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('[data-action="logout"]').forEach(function (btn) {
          btn.addEventListener('click', function (event) {
            event.preventDefault();
            document.getElementById('logout-form').submit();
          });
        });
      });
    </script>
  </body>
</html>
