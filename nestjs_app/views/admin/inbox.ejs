<% const activePage = 'inbox'; %>
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>메시지함 관리</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@1.13.1/css/OverlayScrollbars.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" crossorigin="anonymous" />
  </head>
  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="/adm/dashboard" class="brand-link">
          <span class="brand-text font-weight-light">인싸인 Admin</span>
        </a>
        <div class="sidebar">
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
              <i class="fas fa-user-shield fa-2x text-white-50"></i>
            </div>
            <div class="info">
              <a href="/adm/dashboard" class="d-block"><%= user?.username ?? '관리자' %></a>
            </div>
          </div>
          <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
              <li class="nav-item">
                <a href="/adm/dashboard" class="nav-link <%= activePage === 'dashboard' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>대시보드</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/adm/list" class="nav-link <%= activePage === 'admins' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-users-cog"></i>
                  <p>관리자 계정</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/adm/users" class="nav-link <%= activePage === 'users' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-user-friends"></i>
                  <p>가입자 관리</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/adm/contracts" class="nav-link <%= activePage === 'contracts' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-file-signature"></i>
                  <p>계약 관리</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/adm/templates" class="nav-link <%= activePage === 'templates' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-file-alt"></i>
                  <p>템플릿 관리</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/adm/subscriptions" class="nav-link <%= activePage === 'subscriptions' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-sync-alt"></i>
                  <p>구독 관리</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/adm/plans" class="nav-link <%= activePage === 'plans' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-layer-group"></i>
                  <p>요금제 관리</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/adm/policies" class="nav-link <%= activePage === 'policies' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-shield-alt"></i>
                  <p>약관/정책 관리</p>
                </a>
              </li>
              <li class="nav-item">
              <li class="nav-item">
                <a href="/adm/events" class="nav-link <%= activePage === 'events' ? 'active' : '' %>">
                  <i class="nav-icon fas fa-calendar-alt"></i>
                  <p>이벤트 관리</p>
                </a>
              </li>
                <a href="/adm/inbox" class="nav-link active">
                  <i class="nav-icon fas fa-envelope"></i>
                  <p>메시지함</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <div class="content-wrapper">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1>메시지함 관리</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item"><a href="/adm/dashboard">Home</a></li>
                  <li class="breadcrumb-item active">메시지함</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <section class="content">
          <div class="container-fluid">
            <% if (flashMessage) { %>
            <div class="alert alert-success"><i class="fas fa-check-circle mr-2"></i><%= flashMessage %></div>
            <% } %>
            <% if (errorMessage) { %>
            <div class="alert alert-danger"><i class="fas fa-exclamation-triangle mr-2"></i><%= errorMessage %></div>
            <% } %>

            <div class="row">
              <div class="col-md-4">
                <div class="small-box bg-gradient-primary">
                  <div class="inner">
                    <h3><%= summary.total.toLocaleString('ko-KR') %></h3>
                    <p>전체 메시지</p>
                  </div>
                  <div class="icon"><i class="fas fa-inbox"></i></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="small-box bg-gradient-warning">
                  <div class="inner">
                    <h3><%= summary.unread.toLocaleString('ko-KR') %></h3>
                    <p>읽지 않은 메시지</p>
                  </div>
                  <div class="icon"><i class="fas fa-envelope"></i></div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="small-box bg-gradient-success">
                  <div class="inner">
                    <h3><%= activeUserCountLabel %></h3>
                    <p>활성 사용자 수</p>
                  </div>
                  <div class="icon"><i class="fas fa-users"></i></div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-lg-8">
                <div class="card">
                  <div class="card-header border-0">
                    <div class="d-flex align-items-center justify-content-between flex-wrap">
                      <h3 class="card-title mb-2 mb-sm-0">메시지 목록</h3>
                      <form class="form-inline" method="get" action="/adm/inbox">
                        <div class="form-group mr-2 mb-2 mb-sm-0">
                          <input
                            type="text"
                            class="form-control"
                            name="search"
                            placeholder="이메일/제목 검색"
                            value="<%= filters.search %>"
                          />
                        </div>
                        <div class="form-group mr-2 mb-2 mb-sm-0">
                          <select class="form-control" name="kind">
                            <% kindOptions.forEach(function (option) { %>
                            <option value="<%= option.value %>" <%= option.value === filters.kind ? 'selected' : '' %>>
                              <%= option.label %>
                            </option>
                            <% }) %>
                          </select>
                        </div>
                        <div class="form-group mr-2 mb-2 mb-sm-0">
                          <select class="form-control" name="status">
                            <% statusOptions.forEach(function (option) { %>
                            <option value="<%= option.value %>" <%= option.value === filters.status ? 'selected' : '' %>>
                              <%= option.label %>
                            </option>
                            <% }) %>
                          </select>
                        </div>
                        <button type="submit" class="btn btn-primary mb-2 mb-sm-0">
                          <i class="fas fa-filter mr-1"></i> 필터 적용
                        </button>
                        <a href="/adm/inbox" class="btn btn-default ml-sm-2 mb-2 mb-sm-0">
                          초기화
                        </a>
                      </form>
                    </div>
                  </div>
                  <div class="card-body table-responsive p-0" style="max-height: 580px;">
                    <table class="table table-hover text-nowrap">
                      <thead>
                        <tr>
                          <th style="width: 70px">ID</th>
                          <th style="width: 160px">사용자</th>
                          <th style="width: 110px">유형</th>
                          <th>제목 / 내용</th>
                          <th style="width: 140px">상태</th>
                          <th style="width: 140px">수신일</th>
                          <th style="width: 170px" class="text-right">동작</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (!messages.length) { %>
                        <tr>
                          <td colspan="7" class="text-center text-muted py-4">표시할 메시지가 없습니다.</td>
                        </tr>
                        <% } %>
                        <% messages.forEach(function (item) { %>
                        <tr class="<%= item.isRead ? '' : 'table-warning' %>">
                          <td><strong>#<%= item.id %></strong></td>
                          <td>
                            <div><i class="fas fa-user mr-1 text-secondary"></i><%= item.userEmail %></div>
                            <small class="text-muted"><%= item.userName %></small>
                          </td>
                          <td>
                            <span class="badge <%= item.kindBadgeClass %>"><%= item.kindLabel %></span>
                          </td>
                          <td>
                            <div class="font-weight-bold"><%= item.title %></div>
                            <small class="text-muted d-block"><%= item.bodyPreview || '내용 없음' %></small>
                            <% if (item.tags && item.tags.length) { %>
                            <div class="mt-1">
                              <% item.tags.forEach(function(tag){ %>
                              <span class="badge badge-light text-muted mr-1">#<%= tag %></span>
                              <% }) %>
                            </div>
                            <% } %>
                            <% if (item.metadata) { %>
                            <small class="text-info"><i class="fas fa-info-circle mr-1"></i>메타데이터 포함</small>
                            <% } %>
                          </td>
                          <td>
                            <% if (item.isRead) { %>
                            <span class="badge badge-secondary">읽음</span>
                            <% } else { %>
                            <span class="badge badge-success">읽지 않음</span>
                            <% } %>
                            <div><small class="text-muted">읽음: <%= item.readAt %></small></div>
                          </td>
                          <td><small class="text-muted"><%= item.createdAt %></small></td>
                          <td class="text-right">
                            <form method="post" action="/adm/inbox/<%= item.id %>/read" class="d-inline">
                              <input type="hidden" name="redirectTo" value="<%= currentUrl %>" />
                              <input type="hidden" name="isRead" value="<%= !item.isRead %>" />
                              <button type="submit" class="btn btn-sm <%= item.isRead ? 'btn-outline-info' : 'btn-outline-success' %>">
                                <i class="fas <%= item.isRead ? 'fa-envelope' : 'fa-envelope-open' %> mr-1"></i>
                                <%= item.isRead ? '미읽음' : '읽음 처리' %>
                              </button>
                            </form>
                            <form
                              method="post"
                              action="/adm/inbox/<%= item.id %>/delete"
                              class="d-inline ml-1"
                              onsubmit="return confirm('선택한 메시지를 삭제하시겠습니까?');"
                            >
                              <input type="hidden" name="redirectTo" value="<%= currentUrl %>" />
                              <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash-alt"></i>
                              </button>
                            </form>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card card-outline card-primary">
                  <div class="card-header">
                    <h3 class="card-title">새 메시지 발송</h3>
                  </div>
                  <form method="post" action="/adm/inbox/send">
                    <input type="hidden" name="redirectTo" value="<%= currentUrl %>" />
                    <div class="card-body">
                      <div class="form-group">
                        <label>발송 대상</label>
                        <div class="custom-control custom-radio">
                          <input
                            type="radio"
                            class="custom-control-input"
                            id="audience-all"
                            name="audience"
                            value="all"
                            checked
                          />
                          <label class="custom-control-label" for="audience-all">
                            전체 사용자 (활성)
                          </label>
                        </div>
                        <div class="custom-control custom-radio mt-1">
                          <input
                            type="radio"
                            class="custom-control-input"
                            id="audience-single"
                            name="audience"
                            value="single"
                          />
                          <label class="custom-control-label" for="audience-single">
                            특정 사용자 지정
                          </label>
                        </div>
                        <small class="form-text text-muted">
                          전체 발송은 활성 사용자 <strong><%= activeUserCountLabel %></strong>명에게 인앱 알림을 생성합니다.
                        </small>
                      </div>
                      <div class="form-group">
                        <label class="d-block">메시지 유형</label>
                        <select class="form-control" id="message-kind" name="kind" required>
                          <option value="">선택해주세요</option>
                          <% kindOptions.filter(function(option){ return option.value !== 'all'; }).forEach(function(option){ %>
                          <option value="<%= option.value %>"><%= option.label %></option>
                          <% }) %>
                        </select>
                      </div>
                      <div class="form-group d-none" data-audience-target="email">
                        <label for="message-email">수신자 이메일</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-at"></i></span>
                          </div>
                          <input
                            type="email"
                            class="form-control"
                            id="message-email"
                            name="email"
                            placeholder="user@example.com"
                          />
                        </div>
                        <small class="form-text text-muted">특정 사용자에게 보낼 때만 입력하세요.</small>
                      </div>
                      <div class="form-group">
                        <label for="message-title">제목</label>
                        <input type="text" class="form-control" id="message-title" name="title" placeholder="제목" required />
                      </div>
                      <div class="form-group">
                        <label for="message-body">내용</label>
                        <textarea
                          id="message-body"
                          name="body"
                          class="form-control"
                          rows="5"
                          placeholder="전달할 메시지를 작성하세요."
                          required
                        ></textarea>
                        <small class="form-text text-muted">줄바꿈과 간단한 텍스트만 지원됩니다.</small>
                      </div>
                      <div class="form-group">
                        <label for="message-tags">태그 (선택)</label>
                        <input
                          type="text"
                          class="form-control"
                          id="message-tags"
                          name="tags"
                          placeholder="예: 공지,업데이트"
                        />
                        <small class="form-text text-muted">콤마(,)로 구분하여 여러 개 입력할 수 있습니다.</small>
                      </div>
                      <div class="form-group">
                        <label for="message-metadata">메타데이터 (선택)</label>
                        <textarea
                          id="message-metadata"
                          name="metadata"
                          class="form-control"
                          rows="3"
                          placeholder='예: {"link": "https://in-sign.shop"}'
                        ></textarea>
                        <small class="form-text text-muted">필요한 경우 JSON 형식으로 추가 정보를 첨부하세요.</small>
                      </div>
                    </div>
                    <div class="card-footer">
                      <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-paper-plane mr-1"></i> 발송하기</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="main-footer">
        <strong>인싸인 Admin</strong>
        <div class="float-right d-none d-sm-inline">총 <%= summary.total %>건 / 미확인 <%= summary.unread %>건</div>
      </footer>
    </div>

    <form id="logout-form" method="post" action="/adm/logout" style="display: none;"></form>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@1.13.1/js/jquery.overlayScrollbars.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js" crossorigin="anonymous"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('[data-action="logout"]').forEach(function (el) {
          el.addEventListener('click', function (event) {
            event.preventDefault();
            document.getElementById('logout-form').submit();
          });
        });

        var audienceRadios = document.querySelectorAll('input[name="audience"]');
        var emailGroup = document.querySelector('[data-audience-target="email"]');
        var emailInput = document.getElementById('message-email');

        function refreshAudienceControls() {
          var selected = document.querySelector('input[name="audience"]:checked');
          var mode = selected ? selected.value : 'all';
          var showEmail = mode === 'single';

          if (emailGroup) {
            if (showEmail) {
              emailGroup.classList.remove('d-none');
            } else {
              emailGroup.classList.add('d-none');
            }
          }

          if (emailInput) {
            emailInput.disabled = !showEmail;
            emailInput.required = showEmail;
            if (!showEmail) {
              emailInput.value = '';
            }
          }
        }

        audienceRadios.forEach(function (radio) {
          radio.addEventListener('change', refreshAudienceControls);
        });

        refreshAudienceControls();
      });
    </script>
  </body>
</html>
