<% const activePage = 'policies'; %>
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= title %></title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@2.45.1/dist/css/suneditor.min.css" crossorigin="anonymous" />
  </head>
  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <%- include("../partials/sidebar") %>

      <div class="content-wrapper">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1><%= title %></h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item"><a href="/adm/dashboard">홈</a></li>
                  <li class="breadcrumb-item"><a href="/adm/policies">약관/정책 관리</a></li>
                  <li class="breadcrumb-item active">수정</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <section class="content">
          <div class="container-fluid">
            <div class="row">
              <div class="col-12">
                <div class="card card-primary">
                  <div class="card-header">
                    <h3 class="card-title">약관/정책 정보</h3>
                  </div>
                  <form action="/adm/policies/<%= policy.id %>" method="POST">
                    <div class="card-body">
                      <div class="form-group">
                        <label for="type">유형 <span class="text-danger">*</span></label>
                        <select class="form-control" id="type" name="type" required>
                          <option value="privacy_policy" <%= policy.type === 'privacy_policy' ? 'selected' : '' %>>개인정보 처리방침</option>
                          <option value="terms_of_service" <%= policy.type === 'terms_of_service' ? 'selected' : '' %>>이용약관</option>
                          <option value="sensitive_info" <%= policy.type === 'sensitive_info' ? 'selected' : '' %>>민감정보 수집 이용 동의</option>
                          <option value="marketing" <%= policy.type === 'marketing' ? 'selected' : '' %>>마케팅 활용 동의</option>
                        </select>
                      </div>

                      <div class="form-group">
                        <label for="title">제목 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" value="<%= policy.title %>" required placeholder="예: 개인정보 처리방침 v1.0">
                      </div>

                      <div class="form-group">
                        <label for="version">버전 (선택사항)</label>
                        <input type="text" class="form-control" id="version" name="version" value="<%= policy.version || '' %>" placeholder="예: 1.0.0">
                      </div>

                      <div class="form-group">
                        <div class="custom-control custom-checkbox">
                          <input type="checkbox" class="custom-control-input" id="isActive" name="isActive" value="true" <%= policy.isActive ? 'checked' : '' %>>
                          <label class="custom-control-label" for="isActive">활성화 (앱에서 표시됨)</label>
                          <small class="form-text text-muted">
                            활성화하면 같은 유형의 다른 약관/정책은 자동으로 비활성화됩니다.
                          </small>
                        </div>
                      </div>

                      <div class="form-group">
                        <label for="content">내용 <span class="text-danger">*</span></label>
                        <textarea id="content" name="content" class="form-control"><%= policy.content %></textarea>
                        <small class="form-text text-muted">
                          WYSIWYG 에디터를 사용하여 내용을 작성하세요.
                        </small>
                      </div>
                    </div>

                    <div class="card-footer">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-1"></i> 저장
                      </button>
                      <a href="/adm/policies" class="btn btn-default">
                        <i class="fas fa-times mr-1"></i> 취소
                      </a>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="main-footer">
        <div class="float-right d-none d-sm-block">
          <b>Version</b> 1.0.0
        </div>
        <strong>Copyright &copy; 2024 인싸인.</strong> All rights reserved.
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/suneditor@2.45.1/dist/suneditor.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/suneditor@2.45.1/dist/lang/ko.js" crossorigin="anonymous"></script>
    <script>
      $(document).ready(function () {
        const contentTextarea = document.getElementById('content');
        if (contentTextarea) {
          const editor = SUNEDITOR.create(contentTextarea, {
            height: 520,
            lang: window.SUNEDITOR_LANG ? SUNEDITOR_LANG.ko : undefined,
            buttonList: [
              ['undo', 'redo'],
              ['formatBlock', 'bold', 'underline', 'italic', 'strike'],
              ['fontColor', 'hiliteColor'],
              ['align', 'list', 'lineHeight'],
              ['link', 'table', 'image'],
              ['removeFormat', 'codeView'],
            ],
            defaultStyle:
              "font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif; font-size: 14px; color: #222; line-height: 1.6;",
            attributesWhitelist: {
              table: 'class|style|border|cellpadding|cellspacing',
              tr: 'class|style',
              td: 'class|style|colspan|rowspan',
              th: 'class|style|colspan|rowspan',
              span: 'class|style',
              div: 'class|style',
            },
            onChange: function (contents) {
              contentTextarea.value = contents || '';
            },
          });

          editor.setContents(contentTextarea.value || '');

          const policyForm = contentTextarea.closest('form');
          if (policyForm) {
            policyForm.addEventListener('submit', function () {
              contentTextarea.value = editor.getContents(true) || '';
            });
          }
        }

        $('[data-action="logout"]').on('click', function (e) {
          e.preventDefault();
          if (confirm('로그아웃 하시겠습니까?')) {
            fetch('/adm/logout', { method: 'POST' })
              .then(() => (window.location.href = '/auth/login'))
              .catch((err) => console.error(err));
          }
        });
      });
    </script>
  </body>
</html>
